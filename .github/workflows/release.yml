name: Build & Release

on:
  push:
    tags:
      - "v*"          # Trigger on version tags: v1.0.0, v1.2.3, etc.

permissions:
  contents: write     # Required to create releases and upload assets

jobs:
  build:
    runs-on: windows-latest
    steps:

      # ── Checkout ──────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # ── Python setup ──────────────────────────────────────────────────
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install host dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      # ── Extract version from tag ──────────────────────────────────────
      - name: Extract version from tag
        id: version
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          echo "version=$TAG" >> "$GITHUB_OUTPUT"
          echo "Building version: $TAG"

      - name: Stamp version into __version__.py
        shell: python
        run: |
          version = "${{ steps.version.outputs.version }}"
          with open("fluxdeluxe/__version__.py", "w") as f:
              f.write(f'__version__ = "{version}"\n')

      # ── Build ─────────────────────────────────────────────────────────
      - name: Run build pipeline
        run: python build.py --skip-installer

      # ── Package as zip ────────────────────────────────────────────────
      - name: Create release zip
        shell: pwsh
        run: |
          Compress-Archive -Path "dist\FluxDeluxe\*" -DestinationPath "FluxDeluxe-v${{ steps.version.outputs.version }}.zip"

      # ── Inno Setup installer (optional) ───────────────────────────────
      - name: Update installer version
        shell: python
        run: |
          import re
          version = "${{ steps.version.outputs.version }}"
          path = "installer.iss"
          text = open(path, encoding="utf-8").read()
          text = re.sub(
              r'#define MyAppVersion ".*?"',
              f'#define MyAppVersion "{version}"',
              text,
          )
          open(path, "w", encoding="utf-8").write(text)

      - name: Build installer with Inno Setup
        run: |
          & "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe" installer.iss
        shell: pwsh
        continue-on-error: true

      # ── Create GitHub Release ─────────────────────────────────────────
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: FluxDeluxe v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            FluxDeluxe-v${{ steps.version.outputs.version }}.zip
            output/FluxDeluxe_Setup_v${{ steps.version.outputs.version }}.exe
